# Terraform Configuration for The Things Join Server in AWS

This folder contains Terraform Configuration for deploying The Things Join Server in on an AWS Elastic Kubernetes Service (EKS) cluster in your AWS account.

Prerequisites:

- Terraform 1.3.4 or higher ([download](https://www.terraform.io/downloads))
- AWS Elastic Kubernetes Service (EKS) cluster ([documentation](https://aws.amazon.com/eks/getting-started/))
- Administrator access to an AWS account

## Preparation

This repository uses the default local Terraform Backend. However, it is recommended to use a Terraform Backend to store state. See [Terraform Backends](https://www.terraform.io/language/settings/backends) for more information.

Before proceeding, make sure the Backend is accessible and all dependencies are installed:

```bash
$ terraform init
```

## Configuration

There are various variables to configure The Things Join Server deployment. The most important variables:

| Name                   | Description                 | Default     |
| ---------------------- | --------------------------- | ----------- |
| `region`               | AWS region                  | `eu-west-1` |
| `eks_cluster_name`     | EKS cluster name            |             |
| `kubernetes_namespace` | Kubernetes namespace        | `default`   |
| `provisioners`         | Provisioners                |             |
| `network_servers`      | LoRaWAN Network Servers     |             |
| `application_servers`  | LoRaWAN Application Servers |             |

Besides these variables, you can configure the resource prefixes with `kms_alias_name_prefix`, `resource_prefix` and `ssm_parameter_prefix` to keep multiple deployments of The Things Join Server in the same AWS account apart.

If you have IAM users or roles that need access to The Things Join Server resources (devices and AppSKeys), you can configure them as assume role principals in `assume_role_principals`. This allows these IAM users and roles to assume (or switch) the role. The ARN of this role is the Terraform output `server_role_arn`.

For convenience, you can start your custom configuration from the example configuration:

```bash
$ cp example.tfvars custom.tfvars
```

### Network Servers and Application Servers

You should configure LoRaWAN Network Servers and Application Servers through Terraform Configuration. Passwords are automatically generated by Terraform.

See `example.tfvars` for an example configuration.

## Deploy

Deploy:

```bash
$ terraform apply -var-file custom.tfvars
```

You should see all resources being deployed. This may take a few minutes. When the deployment is done, you see various outputs specific to your deployment.

> ðŸŽ‰ Congratulations! You have now deployed AWS resources for The Things Join Server.

## Next Steps

### Configure Provisioners

The Things Join Server uses HTTP basic authentication to authenticate Provisioners, and TLS client authentication to authenticate Network Servers and Application Servers.

The Terraform Configuration deploys by default a Provisioner with username `root` and a random password. You can obtain the password for `root` via:

```bash
$ terraform output -raw provisioner_passwords
```

Customize provisioners by setting the `provisioners` variable.

### Configure LoRaWAN clients

The Terraform Configuration deploys by default a Network Server with NetID `000013` that trusts clients using The Things Industries Root CA to authenticate The Things Stack Cloud and Community Edition.

Customize Network Server and Application Servers by setting the `network_servers` and `application_servers` variables respectively.

### Deploy The Things Join Server

Deploy The Things Join Server using the Helm chart, [see instructions](../helm-chart/README.md).

## Update

You can pull this repository for updates to the Terraform Configuration. To apply updates:

```bash
# See if everything looks good:
$ terraform plan -var-file custom.tfvars
# Apply the update:
$ terraform apply -var-file custom.tfvars
```

## Destroy

To remove all resources of The Things Join Server:

```bash
$ terraform destroy -var-file custom.tfvars
```

## Legal

Copyright Â© 2022 The Things Industries B.V.
